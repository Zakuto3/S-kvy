<!DOCTYPE html>
<html lang="en">
<head>
    <title>NyaSökvyAppen(NSA)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">  
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">   

	<link id="themes" rel="stylesheet" href="./DarkTheme.css">
	
</head>
<body id='background'>
	<button id="theme_btn" class="info_knapp" value="Dark" data-toggle="tooltip" title="Skifta färgtema">Themes</button>
		<div name='tabellHeader' class='header tabell'>
				TABELLER
			</div>
		<div name='kolumnHeader' class='header kolumn'>
				KOLUMNER
			</div>
		<div name='FTLnSQLHeader' class='header SQLFTL'>
				SKRIPT
			</div>    
		<div name='tabellWindow' class='divs tabell'>
			<input type="text" id="Search" placeholder="Search for names.." title="Search"> 
			<h3><button id='tabellInfo' class='popup info_knapp glyphicon glyphicon-exclamation-sign' data-toggle="collapse" data-target="#tabellInfotext"></button></h3><br>

			<div class= 'precollaps'>
				<div id="tabellInfotext" class="collapse">
					<!--position: absolute; max-width: 50%; right:0px; background-color: black; -->
					<div class= 'info-text'>
					- Till vänster listas sökvyer som specifierats i layerspecification-tabellen i databasen.<br>- Informationen under kommer också direkt från layerspecifications.<br>- Vid ändring av sökvynamn, tänk på att sökvyn kanske inte finns specifierad i layerspecification-tabellen.<br>- Tabell: Vilken tabell som används för sökvyn.<br>- Sökvy: Vad sökvyn du skapar heter.<br>- Titel: Sökvyns titel i geoserver. <br>- Where: Sökvyns where-sats.
					</div>
				</div>
		    </div>
			<select id="layerspecs" size=1 label="Select one:"></select> 
			<h3 data-toggle="tooltip" title="Visar aktuella tabellen">
				Tabell
			</h3>
			<p id="tabell"></p>
			<h3>
				Sökvy 
				<button onclick='changeText(this,"sokvy","newsokvy")' type="button" class="btn btn-info" id="changeName" data-toggle="tooltip" title="Ändrar namn på sökvy tabellen. VARNING: Nya namnet kanske inte finns i 'layer_specification' tabellen i Geoportia databasen, detta kan leda till oförmodad resultat.">Ändra</button>
			</h3>
			<input id='newsokvy' type='text'>				
			<p id="sokvy"></p>
			<h3>
				Titel
				<!--<button onclick='changeText(this,"titel","newtitel")' type="button" class="btn btn-info" id="changeName">Ändra</button>-->
			</h3>
			<input id='newtitel' type='text'>				
			<p id="titel"></p>
			<h3>Where</h3>
			<p id="where"></p>
		</div>
		<div name='kolumnWindow' class='divs kolumn'>
                <h3>Inkluderade kolumner med ev. FTLnamn <button id='kolumnInfo' class='info_knapp glyphicon glyphicon-exclamation-sign popup' data-toggle="collapse" data-target="#kolumnwindowtext"></button></h3>
				
				<div class= 'Precollaps'>
					<div id="kolumnwindowtext" class="collapse">
						<!--position: absolute; max-width: 50%; right:0px; background-color: black; -->
						<div class= 'info-text'>
						- Lägg till de kolumner du vill ha i din sökvy.<br>- Välj vilken som ska vara 'title'.<br>- Sökbara kolumner läggs till i searchfield i sökvyn.<br>
					- För att kolumnen ska vara med i FTL-filen så skriver du något i FTL-fältet.<br>- Du kan välja hur värdet ska representeras genom att välja FTL-typ, 'Värde' är stanardtypen.<br>- Om du vill ändra på ordningen kan du dra runt raderna fritt.
						</div>
					</div>
			    </div>

                <table class="table" id="fler_kolumner">
                    <!--Ändras kanske senare till att läsa från tabell i db "eskilstuna".-->

					<tbody id=mainbody>
						<tr>
							<th>Försvinn!</th>
							<th>Kolumnnamn</th>
							<th>Titel</th>
							<th>Sökbar kolumn</th>
							<th>FTL-namn</th>
							<th>FTL-typ</th>
						</tr>
						<tr >
							<td>
								<button type="button" class="btn btn-danger" name="bortknapp"data-toggle="tooltip" title="Ta bort denna rad">X</button>
							</td>
							<td>
								<select class="dropbox" id="kolumn" name="kolumn">
								</select>
							</td>
							<td>
								<input onchange='checkbox(this)' type='checkbox' id='title' class='title_check' data-toggle="tooltip" title="Det här kolumnnamnet blir titel för nya sökvyn.">
							</td>
							<td>
								<input type="checkbox" id="sokdel" name="checkbox" data-toggle="tooltip" title="För att göra kolumnen sökbar klickar du i bockrutan">
							</td>
							<td>
								<input id='FTLfield' type='text' data-toggle="tooltip" title="Om du vill använda FTL-vy så ange ett användarvänligt namn här, annars lämna det tomt.">
							</td>
							<td>
								<div class="dropdown">
							  	<button onclick='FTLtypes(this)' id="FTLtype" class="FTLtypeBtn dropbtn" data-toggle="tooltip" title="Välj hur kolumnen ska visas i FTL">Värde</button>
								  <div id="FTLlist" class="dropdown-content">
							    <a >Länk</a>
							    <a >Bild</a>
							    <a >Datum</a>
							    <a >Heltal</a>
							 </div> 
							</div>
							</td>
						</tr>
					</body>
				
                </table>
				<button type="button" class="add-all-columns btn btn-info" style="position: relative; left: 0.5em;"data-toggle="tooltip" title="Lägg till alla kolumner från tabellen">Lägg till<br> alla kolumner</button>
				<button class="btn btn-info" id="addbutton" style="position: relative; left: 1em;"data-toggle="tooltip" title="Lägg till en kolumn">+1</button>
            </div>
        <div name='SQLandFTL' class='divs SQLFTL'>	
            <div name='SQLWindow' id='SQLWindow'>
                <h3 class="margin-left">SQL<button id='SQLInfo' class='info_knapp glyphicon glyphicon-exclamation-sign' data-toggle="collapse" data-target="#SQLInfotext"></button></h3>

					<div class= 'precollaps'>
						<div id="SQLInfotext" class="collapse">
							<!--position: absolute; max-width: 50%; right:0px; background-color: black; -->
							<div class= 'info-text'>
							- Här visas SQL-koden.<br>- Tänk på att det krävs en 'title' för att visa koden.<br>- När du är nöjd kan du trycka på 'Skapa sökvyn' för att skapa den i databasen.<br>- Om sökvyn redan finns, tänk på att sökvyn du skapar skriver över den befintliga sökvyn i databasen.
							</div>
						</div>
				    </div>

                <div class="margin-left" readonly id="sql" rows="5" cols="70" autocomplete="off"></div>
                <button type="button" class="btn btn-info margin-left" id="calcbutton" data-toggle="tooltip" title="Visa/Uppdatera SQL koden">Visa SQL</button>
                <button type="button" class="btn btn-info margin-left" id="sendbutton" disabled data-toggle="tooltip" title="Skickar SQL koden till databasen(eskilstuna), detta skapar sökvyn.">Skapa sökvy</button>
            </div>		
			<div name='FTLWindow' id='FTLWindow'>
                <h3 class="margin-left">FTL<button id='FTLInfo' class='info_knapp glyphicon glyphicon-exclamation-sign'data-toggle="collapse" data-target="#FTLWindowtext"></button></h3>

                	<div class= 'precollaps'>
						<div id="FTLWindowtext" class="collapse">
							<!--position: absolute; max-width: 50%; right:0px; background-color: black; -->
							<div class= 'info-text'>
							- Till vänster listas sökvyer som specifierats i layerspecification-tabellen i databasen.<br>- Informationen under kommer också direkt från layerspecifications.<br>- Vid ändring av sökvynamn, tänk på att sökvyn kanske inte finns specifierad i layerspecification-tabellen.<br>- Tabell: Vilken tabell som används för sökvyn.<br>- Sökvy: Vad sökvyn du skapar heter.<br>- Titel: Sökvyns titel i geoserver. <br>- Where: Sökvyns where-sats.
							</div>
						</div>
				    </div>

                <div class="margin-left" readonly id="ftl" rows="5" cols="70" autocomplete="off"></div>
                <button type="button" class="btn btn-info margin-left" id="calcFTL" data-toggle="tooltip" title="Visa/Bygg om FTL-koden">Visa FTL</button>
				<button type="button" class="btn btn-info margin-left" id="saveFTL" disabled data-toggle="tooltip" title="Spara FTL till en content.ftl fil">Spara</button>
				<button type="button" class="btn btn-info margin-left" id="modifyFTL" data-toggle="tooltip" title="Justera den generarade FTL-koden">Modifiera</button>
				<button type="button" class="btn btn-info margin-left" id="FTLcodesButton" data-toggle="tooltip" title="Visa exempel på FTL-kod">Kodexempel</button>
				<br>
				<div id='FTLCodeSnippets'>
					<div id='FTLSnippetsHead'>
				<span id="closeFTLCode" data-toggle="tooltip" title="Stäng kodexemplen">X</span>
					Kodexempel
					</div>
					<p id='FTLSnippetsText'>
					För att ange kolumnvärdet:<br><i>${feature.KOLUMNNAMN.value}</i><br><br>
					Ta bort timmar, minuter och sekunder från timestamps:<br><i>${feature.KOLUMNNAMN.value?string?substring(0,10)}</i><br><br>
					Kapa alla decimaler:<br><i><#assign x=feature.KOLUMNNAMN.value?index_of(".")><br>${feature.KOLUMNNAMN.value?substring(0,x)}</i><br><br>
					För att formatera postnummer när det finns massor av nollor:<br><i>${feature.KOLUMNNAMN.rawValue?c}</i><br><br>
					Lägga till en länk:<br><i>&lt;a href='DIN URL' target='_blank'&gt;DIN TEXT/BILD&lt;/a&gt;</i><br><br>
					Lägga till en bild:<br><i>&lt;img src="DIN SÖKVÄG/URL" width="130px"&gt;</i><br><br>
					Lägg till en rad med Värdet som en länk:
					<br>
					&lt;tr&gt;
					<br>
						&lt;td&gt;&lt;b&gt;FTLNAMNET&lt;/b&gt;&lt;/td&gt;
						&lt;td&gt;&lt;a href='DIN URL' target='_blank'&gt;${feature.KOLUMNNAMN.value}&lt;/a&gt;&lt;/td&gt;
						<br>
					&lt;/tr&gt;
					<br><br>
					&lt;tr&gt; : En rad i inforutan<br>
					&lt;td&gt; : En cell i en rad
					</p>
				</div>		
			</div>
		</div>
	<script type="text/javascript">
//When DOM ready then call node js server and receive layer_spec from db:geoportia then populate selector

$(function () {
	$.ajax({
		type: 'GET',
		url: 'http://localhost:1337/geoportia',
		success: function (lagerspecar) {
			lagerspecar.forEach(function (v) {
				var opt = document.createElement('option');
				opt.textContent = v.name;
				opt.value = v.name + "|" + v.public_title + "|" + v.postgis_table_name + "|" + v.postgis_view_where_condition;
				$("#layerspecs").append(opt);
			});
		}
	});
});

//fill dropbox with table column names from the database
function fillDropBox(kolumner){
	$(".dropbox_option").remove();
	kolumner.forEach(function (kolumn) {
		var option = document.createElement('option');
		option.className = "dropbox_option";
		option.textContent = kolumn.column_name;
		$(".dropbox").append(option);
		});
};		
				
//creates a string which you can insert in the html to create a  new row
function createRow(){
	var row = "<tr>";
	var removeButton = "<td><button type='button' class='btn btn-danger' name='bortknapp' data-toggle='tooltip' title='Ta bort denna rad'>X</button></td>";
	var columnName = "<td><select class='dropbox' id='kolumn' name='kolumn'></select></td>";
	var titleBox = "<td><input onchange='checkbox(this)' type='checkbox' id='title' class='title_check' data-toggle='tooltip' title='Det här kolumnnamnet blir titel för nya sökvyn.' ></td>";
	var searchBox = "<td><input type='checkbox' id='sokdel' name='checkbox' data-toggle='tooltip' title='För att göra kolumnen sökbar klickar du i bockrutan'></td>";
	var FTLfield = "<td><input id='FTLfield' type='text'data-toggle='tooltip' title='Om du vill använda FTL-vy så ange ett användarvänligt namn här, annars lämna det tomt'></td>"
	var FTLtype = "<td><div class='dropdown'><button onclick='FTLtypes(this)' id='FTLtype' class='FTLtypeBtn dropbtn' data-toggle='tooltip' title='Välj hur kolumnen ska visas i FTL'>Värde</button><div id='FTLlist' class='dropdown-content'><a>Länk</a><a>Bild</a><a>Datum</a><a >Heltal</a></div> </div></td>"
	row += removeButton + columnName + titleBox + searchBox + FTLfield + FTLtype +"</tr>";
	return row;


};

//onclick event in the html
//unchecks all title-checkboxes except for the one you click.
function checkbox(title){
	$('input[id="' + title.id + '"]').not(title).prop('checked', false);
}
	
function update_fixed_fields(array) {
    //document.getElementById("tabell").innerHTML=array[2];
    $('#sokvy').text(array[0]);
	$('#newsokvy').val(array[0]);
    $('#titel').text(array[1]);
	$('#newtitel').val(array[1]);
    $('#tabell').text(array[2]);
    if (array[3] != 'null') {
        $('#where').text(array[3]);
    } else { $('#where').text("") };
};

//reads the current table from the database to get the columns
function readTableColumns(){
	var layerspecs = document.getElementById("layerspecs");
	var split = layerspecs.value.split("|");
	update_fixed_fields(split);
	$.ajax({
        type: 'GET',
        url: 'http://localhost:1337/eskilstuna/' + $('#tabell').text(),
        success: function (json) {
            fillDropBox(json);	//use the columns to fill/update the dropbox
			//updateAllDropboxes();
        }
	})
}
//allows for selection in search dropdown
$("#layerspecs").keyup(function( event ) {
	if(event.key == "Enter")
	this.size = 1;
});

//collapse the dropdown when selecting a option
$("#layerspecs").mouseup(function(){
	this.size = 1;
	$(this).trigger("change");
});

//remove all rows except the first one and update the data
$("#layerspecs").on('change', function(){
	var length = $(".dropbox").length - 1;
	$("#fler_kolumner tr:gt(1)").remove();
	readTableColumns();
	$("#sendbutton").prop('disabled', 'true');
});

//reads columns from database and updates the whole table
$(".add-all-columns").on('click', function(){
	var options = $(".dropbox:first option").length;
	var dropboxes = $(".dropbox").length;
	var boxesToAdd = options - dropboxes;
	for(var i = 0; i < boxesToAdd; i++){
			$("table").append(createRow());
			updateNewDropbox();
	};
	$("#sendbutton").prop('disabled', 'true');	
});

/*copies data from the row above and
	sets dropbox default value to whatever
	its index is, same as updateAllDropboxes
	but for +1 clickevent*/
function updateNewDropbox(){
	var index = $(".dropbox").length - 1;
	var newDropBox = $("table").find("select:last");
	$("#kolumn:first option").each(function(){
		var opt = document.createElement('option');
		opt.textContent = this.text;
		opt.className = "dropbox_option";
		newDropBox.append(opt);
	})
	var options = newDropBox.children();
	if(options.length > index){
		newDropBox.val(options[index].text);
	}
}
	
/*adds a new row when clicking on +1*/
$("#addbutton").click(function () {
	$("table").append(createRow()); // new createRow func
	updateNewDropbox();	//update the new dropbox
	$("#sendbutton").prop('disabled', 'true');
});

//clickevent to remove a row
$(document).on('click', 'button.btn-danger', function () {
    var rows = $("#mainbody").children(); 
	if(rows.length > 2)
	{
		$(this).closest('tr').remove();
		$("#sendbutton").prop('disabled', 'true');
	}
});

/*reads row and sends a object with
	information to serverside which
	returns an sqlQuery*/
$("#calcbutton").click(function () {
    var samling = {}; //tabellobjekt
    var title_is_present = false;
    $('#fler_kolumner tr').each(function (k) {// 'table row'
        var obj = {};
        $(this).find("input,select").each(function (i) {
			if (this.id.indexOf('sokdel') >= 0) {
				if ($(this).is(":checked")) 
				{
					obj["sokdel"] = "j";
				}
				else 
				{
					obj["sokdel"] = "n";
				}
			}
			if (this.id.indexOf('title') >= 0) 
			{
				if($(this).is(":checked"))
				{
					title_is_present = true;
					obj["title"] = "j";
				}
				else
				{
					obj["title"] = "n";
				}
			}
			if(this.id.indexOf('kolumn') >= 0)
			{
				obj["kolumn"] = $(this).val();
			}
		});
	samling["row" + k] = obj;
	});
	if (!title_is_present) 
	{
		alert("Måste ange en title");
		return;
	}
	else 
	{
	samling["tabellnamn"] = $('#tabell').text();
	samling["sokvynamn"] = $('#sokvy').text();
	samling["titel"] = $('#titel').text();
	samling["where"] = $('#where').text();
	$('#sql').html("<code class='code_snippets' id='SQL'>" + SQLBuilder(samling) + "</code>");
	$('#sendbutton').prop("disabled", false);
	}
});

//trigger FTLfunctions on click	
$("#calcFTL").click(calcFTL);
$("#saveFTL").click(saveFTL);

/*calculates which columns to be included in FTL
	and show the completed FTLtext on screen*/
function calcFTL (){
	var FTLnamn = [];
	var kolumnNamn = [];
	var FTLtypes = [];
	$('#fler_kolumner tr').each(function (k) {// 'table row'
		$(this).find("input,select, button").each(function (i) {
			if (this.id.indexOf('FTLfield') >= 0) {
				FTLnamn[k] = $(this).val();
			}
			if (this.id.indexOf('kolumn') >= 0){
				kolumnNamn[k] = $(this).val();
			}
			if (this.id.indexOf('FTLtype') >= 0){
				FTLtypes[k] = $(this).text();
			}
		});
	});
	/*send columnNames and FTLNames into FTLbuilder
		and get the completed FTLstring*/
	var FTLString = FTLbuilder(FTLnamn, kolumnNamn,FTLtypes); 
	$('#ftl').html("<textarea disabled id='textareaFTL'>"+FTLString+"</textarea>"); 
	$('#saveFTL').prop("disabled", false);
}


//builds the FTLstring and returns it(frankenstein)
function FTLbuilder(FTLarr, kolumnArr,FTLtypes){ 
	let B = { 
		 OT : "&lt;", //<
		 CT : "&gt;", //>
		 Obold : "&lt;" + "b" + "&gt;", //<b>
		 Cbold : "&lt;" + "/b" + "&gt;", //</b>
		 tab : "\t",
		 BR : "\n",
		 Otr : "\t\t\t"+"&lt;"+"tr", // /t/t/t<tr
		 Ctr : "\t\t\t"+"&lt;"+"/tr", // /t/t/t</tr
		 td : "\t\t\t\t"+"&lt;"+"td"+"&gt;", // /t/t/t/t<td>
		 OUL : "\t\t"+"&lt;"+"ul"+"&gt;"+"\n", // /t/t<ul><br>
		 CUL : "\t\t"+"&lt;"+"/ul"+"&gt;"+"\n" // /t/t</ul><br>
	};

	let FTLbegin = B.OT+"#list features as feature"+B.CT+B.BR;
	let FTLmiddle = "";
	let FTLend = B.CUL+B.tab+B.OT+"/table"+B.CT+B.BR+
					B.OT+"/#list"+B.CT;	
	FTLbegin += B.tab+B.OT+'table class="featureInfo"'+B.CT+B.BR+B.OUL;

	for(amount in kolumnArr)
	{
		if(FTLarr[amount] != "") //check if FTLfield was empty
			FTLmiddle += BuildRow(kolumnArr[amount], FTLarr[amount], FTLtypes[amount],B);
	}
	return FTLbegin + FTLmiddle+FTLend;
};

//Builds a row in FTL based on the type chosen
function BuildRow(kolumn, name, type, B){
	let FTLrow;
		switch(type){
			case "Länk": 
				FTLrow = B.Otr+B.CT+B.BR+B.td+B.OT+"a href='${feature."+kolumn+".value}' target='_blank'"+B.CT+name+B.OT+"/a"+B.CT+B.OT+"/td"+B.CT+B.BR+
				B.Ctr+B.CT+B.BR;
				 break;

			case "Datum":
				FTLrow = B.Otr+B.CT+B.BR+
				B.td+B.Obold+name+":"+B.Cbold+B.OT+"/td"+B.CT+B.BR+
				B.td+"${feature."+kolumn+".value?string?substring(0,10)}"+B.OT+"/td"+B.CT+B.BR+
				B.Ctr+B.CT+B.BR;
				break;

			case "Bild":
				FTLrow = B.Otr+B.CT+B.BR+B.td+B.OT+"img src='${feature."+kolumn+".value}' width='130px'"+B.CT+B.OT+"/td"+B.CT+B.BR+
				B.Ctr+B.CT+B.BR;
				break;

			case "Heltal":
				FTLrow = B.Otr+B.CT+B.BR+"\t\t\t\t<#assign x=feature."+kolumn+".value?index_of('.')>"+B.BR+B.td+B.Obold+name+":"+B.Cbold+B.OT+"/td"+B.CT+B.BR+
				B.td+"${feature."+kolumn+".value?string?substring(0,x)}"+B.OT+"/td"+B.CT+B.BR+
				B.Ctr+B.CT+B.BR;
				break;

			default: 
				FTLrow =  B.Otr+B.CT+B.BR+
				B.td+B.Obold+name+":"+B.Cbold+B.OT+"/td"+B.CT+B.BR+
				B.td+"${feature."+kolumn+".value}"+B.OT+"/td"+B.CT+B.BR+
				B.Ctr+B.CT+B.BR;
				 break;

		}
	return FTLrow;
}

/*downloads the FTLstring into
	a content.ftl file*/
function saveFTL(){
	var FTLtext = $("#textareaFTL").val();
	var file = new Blob([FTLtext]);
	var a = document.createElement("a"),
    url = URL.createObjectURL(file);
    a.href = url;
    a.download = "content.ftl";
    document.body.appendChild(a);
    a.click();
    setTimeout(function() {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);  
    }, 0); 
}

$("#sendbutton").click(SendSQL);

//Sends query to serverside and the database
function SendSQL(){
	var SqlQuery = {};
	SqlQuery["query"] = $("#SQL").text();	
	$.post('http://localhost:1337/Core', SqlQuery, function (error) 
	{
			if(error.code == "42P07") 
			{
				if (confirm("Sökvyn med namnet finns redan, vill du ta bort och skapa ny?")) {
					SqlQuery["query"] = "DROP VIEW " + $("#sokvy").text() + "; " + SqlQuery["query"];
					$.post('http://localhost:1337/Core', SqlQuery, function(err)
					{
						if(err.code != undefined) alert("Något gick fel");
						else alert("Sökvy skapad");
					});
				}
			}
            else
			{
				alert("Sökvy skapad");
			}
    });
}

/*Toggles between text input field and paragraph
	and makes it possible to change what is in
	the paragraph*/
function changeText(button,idText,idInput){

	if(!IlligalChar($("#"+idInput).val()) && $(button).text()== "Bekräfta"){ 
		alert("Endast engelska bokstäver, siffror och understreck. Måste börja med en bokstav.");
		return;
	}

	$("#"+idInput).toggle();
	$("#"+idText).toggle();
	$("#"+idText).text($("#"+idInput).val());
	if($(button).text() == "Ändra") { $(button).text("Bekräfta"); }
	else 
	{
		$("#sendbutton").prop('disabled', 'true');
		$(button).text("Ändra");
	}
}

$("#fler_kolumner").on('change', function(){
	$("#sendbutton").prop('disabled', 'true');
	});

//regex for not allow certain characters
function IlligalChar(strToCheck){
var Regexp = /^[a-z][a-z0-9_]*$/i;//Only allows for English chars, numbers and underscore (͡°͜ʖ͡°)
return Regexp.test(strToCheck);
}

//Builds the SQL-code to send to database
function SQLBuilder (data) {

    var tabelln = data.tabellnamn;
    var sokvyn = data.sokvynamn;
    var where = data.where;
    var titel = data.titel;
    var sokbara = "";
    var sistaknamn = "";
    var skapasokvy_str = "CREATE VIEW ";
	var finnsSokBar = false;
	var finnsWhere = (where=='') ? ';':'';
    skapasokvy_str += sokvyn; 
    skapasokvy_str += " AS SELECT ";
    skapasokvy_str += '"' + tabelln + '".geom, ' + '"' + tabelln + '".geodb_oid AS sokid, ';

    function process(key, value) {
        if (key == "kolumn") 
		{
            skapasokvy_str += '"' + tabelln + '"."' + value + '"';
            sistaknamn = value;
        }
        else if (key == "title") 
		{
            if (value == "j") 
			{
				skapasokvy_str += " AS title, ";
			}
            else 
			{
                skapasokvy_str += ", "; 
            }
        }


        else if(key == "sokdel") 
        {
            if (value == "j") 
			{
                sokbara += '"' + sistaknamn +'",';
				finnsSokBar = true;
            }
        }
          
    };
    function traverse(o, func) {
        for (let i in o) {
            if (o[i] !== null && typeof (o[i]) == "object") {
                traverse(o[i], func);
            }
            else if (i == "kolumn" || i == "title" || i == "sokdel") {
                func.apply(this, [i, o[i]]); //http://www.w3schools.com/js/js_function_invocation.asp
            }
        }
    };
    traverse(data, process);
    sokbaraArray = sokbara.split(",");
    sokbaraArray.pop();	

	
	if(finnsSokBar)	
	{
		skapasokvy_str += " concat_ws(', '," + sokbaraArray + ")::text AS searchfield ";
	} 
	else
	{
		//replace "," with space for correct sql syntax
		skapasokvy_str = skapasokvy_str.substring(0,skapasokvy_str.length-2); 
		skapasokvy_str += " ";
	}	

	skapasokvy_str += "FROM " + '"' + tabelln +'" '+where + finnsWhere;
    return skapasokvy_str;
}


//filters tables when searching in searchfield
$("#Search").keyup(function searchFunc(event) {
    var filter, layerspec, options, i,laySize=0;
    filter = document.getElementById("Search").value.toUpperCase();
    layerspec = document.getElementById("layerspecs");
    options = layerspec.getElementsByTagName("option");
    for (i = 0; i < options.length; i++){
        
        if (options[i].innerHTML.toUpperCase().indexOf(filter) > -1) {
            options[i].style.display = "block";
            laySize++;
        } else {
            options[i].style.display = "none";
        }
    }   
    layerspec.size=laySize+1;
    if (event.key == "ArrowDown")
    layerspec.focus();  
    if(filter=="")
    layerspec.size=1;
});

//toggle FTLtypebuttons
function FTLtypes(thebutton) {
    $(thebutton).next().toggle();
}

//replaces buttons text with selected value in dropbox
$(document).on('click',"[id=FTLlist] a", function(){
		let button = $(this).closest("#FTLlist").siblings();
	let currentText = $(this).text();
	$(this).text(button.text());
	button.text(currentText);

});

//show or hide FTltypebutton based or FTLfield input
$(document).on('keyup',"[id=FTLfield]", function(){
	if($(this).val() == ""){
		$(this).parent().siblings().children(".dropdown").children("#FTLtype").css('visibility', 'hidden');
	}
	else{
		$(this).parent().siblings().children(".dropdown").children("#FTLtype").css('visibility', 'visible');
	}
});

// Close the dropdown if the user clicks outside of it
window.onclick = function(event) {	
  if (!event.target.matches('.dropbtn')) {	
    var dropdowns = document.getElementsByClassName("dropdown-content");
    for (let i = 0; i < dropdowns.length; i++) {
      dropdowns[i].style.display = "none";     
    }
  }
}

$("#modifyFTL").click(ModFTL);

$("#calcFTL").click(CheckFTLButtons);

//button changes with FTLbutton
function CheckFTLButtons(){
	$('#saveFTL').prop("disabled", false);
	$("#calcFTL").text("Ladda om FTL");
	$("#modifyFTL").css('display', 'inline-block');
}

//hide button and enable textarea
function ModFTL(){
	$("#textareaFTL").prop('disabled',false);
	$("#modifyFTL").toggle();
}

$("#FTLcodesButton").click(function(){
	$("#FTLCodeSnippets").css("display",'block');
	$(this).toggle();
});

$("#closeFTLCode").click(function(){
	$("#FTLCodeSnippets").css("display",'none');
	$("#FTLcodesButton").toggle();
});
	
/*Function makes it possible to use tab 
	in the FTLtextarea*/
$(document).delegate('#textareaFTL', 'keydown', function(event) {
  var keyCode = event.keyCode || event.which;

  if (keyCode == 9) {
    event.preventDefault();
    var start = this.selectionStart;
    var end = this.selectionEnd;

    // set textarea value to: text before caret + tab + text after caret
    $(this).val($(this).val().substring(0, start)
                + "\t"
                + $(this).val().substring(end));

    // put caret at right position again
    this.selectionStart =
    this.selectionEnd = start + 1;
  }
});
	
$("#theme_btn").click(ChangeTheme);	

function ChangeTheme (){
	var btnValue = $("#theme_btn").val();
	switch(btnValue){
		case "Dark":
		 $("#themes").attr('href','LightTheme.css');
		 $("#theme_btn").val("Light");
		break;

		case "Light":
		$("#themes").attr('href','DarkTheme.css');
		$("#theme_btn").val("Dark");
		break;

	}
}

//jqueryUI för att göra lista DOMelement sorterbar
$('#fler_kolumner tbody').sortable();
</script>
</body>
</html>