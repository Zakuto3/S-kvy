<!DOCTYPE html>
<html lang="en">
<head>
    <title>Jej er en fin haj</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">  
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">   

	<link rel="stylesheet" href="./style.css">
	
</head>
<body>
		<div name='tabellHeader' class='header tabell'>
			TABELLER
		</div>
		<div name='kolumnHeader' class='header kolumn'>
			KOLUMNER
		</div>
		<div name='FTLnSQLHeader' class='header SQLFTL'>
			SKRIPT
		</div>    
        <div name='tabellWindow' class='divs tabell'>
				<h3><button id='tabellInfo' class='popup info_knapp glyphicon glyphicon-exclamation-sign popup'></button></h3><br>
                <select id="layerspecs" label="Select one:"></select> <br>
                <h3 data-toggle="tooltip" title="Visar aktuella tabellen">
					Tabell
				</h3>
                <p id="tabell"></p>
                <h3>
					Sökvy 
					<button onclick='changeText(this,"sokvy","newsokvy")' type="button" class="btn btn-info" id="changeName" data-toggle="tooltip" title="Ändrar namn på sökvy tabellen. VARNING: Nya namnet kanske inte finns i 'layer_specification' tabellen i Geoportia databasen, detta kan leda till oförmodad resultat.">Ändra</button>

				</h3>
				<input id='newsokvy' type='text'>				
                <p id="sokvy"></p>
                <h3>
					Titel
					<!--<button onclick='changeText(this,"titel","newtitel")' type="button" class="btn btn-info" id="changeName">Ändra</button>-->
				</h3>
                <input id='newtitel' type='text'>				
                <p id="titel"></p>
				
                <h3>Where</h3>
                <p id="where"></p>
            </div>
		<div name='kolumnWindow' class='divs kolumn'>
                <h3>Inkluderade kolumner med ev. FTLnamn <button id='kolumnInfo' class='info_knapp glyphicon glyphicon-exclamation-sign'></button></h3>
				
                <table class="table" id="fler_kolumner">
                    <!--Ändras kanske senare till att läsa från tabell i db "eskilstuna".-->

					<tbody id=mainbody>
						<tr style='text-align: center;'>
							<th>Försvinn!</th>
							<th>Kolumnnamn</th>
							<th>Titel</th>
							<th>Sökbar kolumn</th>
							<th style='text-align: left;'>FTL-namn</th>
						</tr>
						<tr >
							<td>
								<button type="button" class="btn btn-danger" name="bortknapp"data-toggle="tooltip" title="Ta bort denna rad">X</button>
							</td>
							<td>
								<select class="dropbox" id="kolumn" name="kolumn">
								</select>
							</td>
							<td>
								<input onchange='checkbox(this)' type='checkbox' id='title' class='title_check' data-toggle="tooltip" title="Denna kolumnnamn blir title för nya sökvyn">
							</td>
							<td>
								<input type="checkbox" id="sokdel" name="checkbox" data-toggle="tooltip" title="För att göra kolumnen sökbar klickar du i bockrutan">
							</td>
							<td>
								<input id='FTLfield' type='text' data-toggle="tooltip" title="Om du vill använda FTL-vy så ange ett användarvänligt namn här, annars lämna det tomt.">
							</td>
						</tr>
					</body>
				
                </table>
				<button type="button" class="add-all-columns btn btn-info" style="position: relative; left: 0.5em;"data-toggle="tooltip" title="Lägg till alla kolumner från tabellen">Lägg till<br> alla kolumner</button>
				<button class="btn btn-info" id="addbutton" style="position: relative; left: 1em;"data-toggle="tooltip" title="Lägg till en kolumn">+1</button>
            </div>
        <div name='SQLandFTL' class='divs SQLFTL'>	
            <div name='SQLWindow' id='SQLWindow'>
                <h3 class="margin-left">SQL<button id='SQLInfo' class='info_knapp glyphicon glyphicon-exclamation-sign'></button></h3>
                <div class="margin-left" readonly id="sql" rows="5" cols="70" autocomplete="off"></div>
                <button type="button" class="btn btn-info margin-left" id="calcbutton" data-toggle="tooltip" title="Visa/Uppdatera SQL koden">Visa SQL</button>
                <button type="button" class="btn btn-info margin-left" id="sendbutton" disabled data-toggle="tooltip" title="Skickar SQL koden till databasen(eskilstuna), detta skapar sökvyn.">Skapa sökvy</button>
            </div>		
			<div name='FTLWindow' id='FTLWindow'>
                <h3 class="margin-left">FTL<button id='FTLInfo' class='info_knapp glyphicon glyphicon-exclamation-sign'></button></h3>
                <div class="margin-left" readonly id="ftl" rows="5" cols="70" autocomplete="off"></div>
                <button type="button" class="btn btn-info margin-left" id="calcFTL" data-toggle="tooltip" title="Visa/Uppdatera FTL koden">Visa FTL</button>
				<button type="button" class="btn btn-info margin-left" id="saveFTL" disabled data-toggle="tooltip" title="Spara FTL till en content.ftl fil">Spara</button>
				<button type="button" class="btn btn-info margin-left" id="modifyFTL" data-toggle="tooltip" title="Justera den generarade FTL-koden">Modifiera</button>
				<button type="button" class="btn btn-info margin-left" id="FTLcodesButton" data-toggle="tooltip" title="Visa exempel på FTL-kod">Kodexempel</button>
				<br>
				<div id='FTLCodeSnippets'>
					<div id='FTLSnippetsHead'>
				<span id="closeFTLCode" data-toggle="tooltip" title="Stäng kodexemplen">X</span>
					Kod
					</div>
					<p id='FTLSnippetsText'>
					Ta bort timmar, minuter och sekunder från timestamps:<br><i>${KOLUMNVÄRDE?string?substring(0,10)}</i><br><br>
					hello<br>
					hehe
					</p>
				</div>
				<!--<button type="button" class="btn btn-info margin-left" id="addFTLLink" data-toggle="tooltip" title="Skapa en href i FTL">Lägg till länk</button><br>
				<div style="display: none;" class="margin-left plink">
					Länk URL: <br>					
					<div id="FTLLinkp" style="display: block;" class="margin-left"></div>
					<input style="display: none;" class="margin-left" type='text' id='FTLLink'></input>
				</div>
				<div style="display: none;" class="margin-left plink">
					Länk Namn: <br>
					<div id="FTLLinkNamnp" style="display: block;" class="margin-left"></div>
					<input style="display: none;" type='text' class="margin-left" id='FTLLinkNamn'></input>
				</div>	-->			
            </div>
		</div>

	<script type="text/javascript">
//When DOM ready then call node js server and receive layer_spec from db:geoportia then populate selector

$(function () {
	var lagerspecar = "kattkatt";
	$.ajax({
		type: 'GET',
		url: 'http://localhost:1337/geoportia',
		success: function (json) {
			lagerspecar = json;
			lagerspecar.forEach(function (v) {
				var opt = document.createElement('option');
				opt.textContent = v.name;
				opt.value = v.name + "|" + v.public_title + "|" + v.postgis_table_name + "|" + v.postgis_view_where_condition;
				$("#layerspecs").append(opt);
			});
			// $("#layerspecs").append('<option value='+ object.public_title + '>' + object.name + '</option>');
		}
	});
});

//fill dropbox with table column names from the database
function fillDropBox(kolumner){
	$(".dropbox_option").remove();
	kolumner.forEach(function (kolumn) {
		var option = document.createElement('option');
		option.className = "dropbox_option";
		option.textContent = kolumn.column_name;
		$(".dropbox").append(option);
		});
};		
				
//creates a string which you can insert in the html to create a  new row
function createRow(){
	var row = "<tr>";
	var removeButton = "<td><button type='button' class='btn btn-danger' name='bortknapp' data-toggle='tooltip' title='Ta bort denna rad'>X</button></td>";
	var columnName = "<td><select class='dropbox' id='kolumn' name='kolumn'></select></td>";
	var titleBox = "<td><input onchange='checkbox(this)' type='checkbox' id='title' class='title_check' data-toggle='tooltip' title='Denna kolumnnamn blir title för nya sökvyn' ></td>";
	var searchBox = "<td><input type='checkbox' id='sokdel' name='checkbox' data-toggle='tooltip' title='För att göra kolumnen sökbar klickar du i bockrutan'></td>";
	var FTLfield = "<td><input id='FTLfield' type='text'data-toggle='tooltip' title='Om du vill använda FTL-vy så ange ett användarvänligt namn här, annars lämna det tomt'></td>"
	row += removeButton + columnName + titleBox + searchBox + FTLfield + "</tr>";
	return row;
};

//onclick event in the html
//unchecks all title-checkboxes except for the one you click.
function checkbox(title){
	$('input[id="' + title.id + '"]').not(title).prop('checked', false);
}
	
function update_fixed_fields(array) {
    //document.getElementById("tabell").innerHTML=array[2];
    $('#sokvy').text(array[0]);
	$('#newsokvy').val(array[0]);
    $('#titel').text(array[1]);
	$('#newtitel').val(array[1]);
    $('#tabell').text(array[2]);
    if (array[3] != 'null') {
        $('#where').text(array[3]);
    } else { $('#where').text("") };
};

//reads the current table from the database to get the columns
function readTableColumns(){
	var layerspecs = document.getElementById("layerspecs");
	var split = layerspecs.value.split("|");
	update_fixed_fields(split);
	$.ajax({
        type: 'GET',
        url: 'http://localhost:1337/eskilstuna/' + $('#tabell').text(),
        success: function (json) {
            fillDropBox(json);	//use the columns to fill/update the dropbox
			//updateAllDropboxes();
        }
	})
}

//remove all rows except the first one and update the data
$("#layerspecs").on('change', function(){
	var length = $(".dropbox").length - 1;
	$("#fler_kolumner tr:gt(1)").remove();
	readTableColumns();
	$("#sendbutton").prop('disabled', 'true');
});

//reads columns from database and updates the whole table
$(".add-all-columns").on('click', function(){
	var options = $(".dropbox:first option").length;
	var dropboxes = $(".dropbox").length;
	var boxesToAdd = options - dropboxes;
	for(var i = 0; i < boxesToAdd; i++){
			$("table").append(createRow());
			updateNewDropbox();
	};
	$("#sendbutton").prop('disabled', 'true');	
});

/*copies data from the row above and
	sets dropbox default value to whatever
	its index is, same as updateAllDropboxes
	but for +1 clickevent*/
function updateNewDropbox(){
	var index = $(".dropbox").length - 1;
	var newDropBox = $("table").find("select:last");
	$("#kolumn:first option").each(function(){
		var opt = document.createElement('option');
		opt.textContent = this.text;
		opt.className = "dropbox_option";
		newDropBox.append(opt);
	})
	var options = newDropBox.children();
	if(options.length > index){
		newDropBox.val(options[index].text);
	}
}
	
/*adds a new row when clicking on +1*/
$("#addbutton").click(function () {
	$("table").append(createRow()); // new createRow func
	updateNewDropbox();	//update the new dropbox
	$("#sendbutton").prop('disabled', 'true');
});

//clickevent to remove a row
$(document).on('click', 'button.btn-danger', function () {
    var rows = $("#mainbody").children(); 
	if(rows.length > 2)
	{
		$(this).closest('tr').remove();
		$("#sendbutton").prop('disabled', 'true');
	}
});

/*reads row and sends a object with
	information to serverside which
	returns an sqlQuery*/
$("#calcbutton").click(function () {
    var samling = {}; //tabellobjekt
    var title_is_present = false;
    $('#fler_kolumner tr').each(function (k) {// 'table row'
        var obj = {};
        $(this).find("input,select").each(function (i) {
			if (this.id.indexOf('sokdel') >= 0) {
				if ($(this).is(":checked")) 
				{
					obj["sokdel"] = "j";
				}
				else 
				{
					obj["sokdel"] = "n";
				}
			}
			if (this.id.indexOf('title') >= 0) 
			{
				if($(this).is(":checked"))
				{
					title_is_present = true;
					obj["title"] = "j";
				}
				else
				{
					obj["title"] = "n";
				}
			}
			if(this.id.indexOf('kolumn') >= 0)
			{
				obj["kolumn"] = $(this).val();
			}
		});
	samling["row" + k] = obj;
	});
	if (!title_is_present) 
	{
		alert("Måste ange en title");
		return;
	}
	else 
	{
	samling["tabellnamn"] = $('#tabell').text();
	samling["sokvynamn"] = $('#sokvy').text();
	samling["titel"] = $('#titel').text();
	samling["where"] = $('#where').text();
	$('#sql').html("<code class='code_snippets' id='SQL'>" + SQLBuilder(samling) + "</code>");
	$('#sendbutton').prop("disabled", false);
	/*$.post('http://localhost:1337/eskilstuna_nyvy', samling, function (data, status) {
		$('#sql').html("<code class='code_snippets' id='SQL'>" + data + "</code>");
		$('#sendbutton').prop("disabled", false);
	});*/
	}
});

//trigger FTLfunctions on click	
$("#calcFTL").click(calcFTL);
$("#saveFTL").click(saveFTL);

/*calculates which columns to be included in FTL
	and show the completed FTLtext on screen*/
function calcFTL (){
	var FTLnamn = [];
	var kolumnNamn = [];
	$('#fler_kolumner tr').each(function (k) {// 'table row'
		$(this).find("input,select").each(function (i) {
			if (this.id.indexOf('FTLfield') >= 0) {
				FTLnamn[k] = $(this).val();
			}
			if (this.id.indexOf('kolumn') >= 0){
				kolumnNamn[k] = $(this).val();
			}
		});
	});
	
	/*send columnNames and FTLNames into FTLbuilder
		and get the completed FTLstring*/
	var FTLString = FTLbuilder(FTLnamn, kolumnNamn); 
	//$('#ftl').html("<code class='code_snippets' id='FTL'>"+FTLString+"</code>"); 
	$('#ftl').html("<textarea disabled id='textareaFTL'>"+FTLString+"</textarea>");

}

//builds the FTLstring and returns it(frankenstein)
function FTLbuilder(FTLarr, kolumnArr){ 
	let OT = "&lt;"; //<
	let CT = "&gt;"; //>
	let Obold = OT + "b" + CT; //<b>
	let Cbold = OT + "/b" + CT; //</b>
	let tab = "\t";
	let BR = "\n";
	let Otr = tab+tab+tab+OT+"tr"; // /t/t/t<tr
	let Ctr = tab+tab+tab+OT+"/tr"; // /t/t/t</tr
	let td = tab+tab+tab+tab+OT+"td"+CT; // /t/t/t/t<td>
	let OUL = tab+tab+OT+"ul"+CT+BR; // /t/t<ul><br>
	let CUL = tab+tab+OT+"/ul"+CT+BR; // /t/t</ul><br>
	let FTLbegin = OT+"#list features as feature"+CT+BR;
	let FTLmiddle = "";
	let FTLend = CUL+tab+OT+"/table"+CT+BR+
					OT+"/#list"+CT;	
					
	console.log("LINK: "+  $("#FTLLink").val());
	if($("#FTLLinkp").text() != '') FTLbegin += OT + "a href ='"+ $("#FTLLinkp").text() +"' target='_blank'" + CT
		+ OT+"b"+CT+ $("#FTLLinkNamnp").text() + OT + "/b" + CT + OT + "/a"+ CT + BR;  //"<a href='' target='_blank'><b>Placeholder</b></a>";
	FTLbegin += tab+OT+'table class="featureInfo"'+CT+BR+OUL;
	
	for(amount in kolumnArr)
	{
		if(FTLarr[amount] != "") //check if FTLfield was empty
		FTLmiddle += Otr+CT+BR+
						td+Obold+FTLarr[amount]+":"+Cbold+OT+"/td"+CT+BR+
						td+"${feature."+kolumnArr[amount]+".value}"+OT+"/td"+CT+BR+
						Ctr+CT+BR;
	}
	return FTLbegin + FTLmiddle+FTLend;
};

/*downloads the FTLstring into
	a content.ftl file*/
function saveFTL(){
	var FTLtext = $("#textareaFTL").val();
	var file = new Blob([FTLtext]);
	var a = document.createElement("a"),
            url = URL.createObjectURL(file);
    a.href = url;
    a.download = "content.ftl";
    document.body.appendChild(a);
    a.click();
    setTimeout(function() {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);  
    }, 0); 
	//var downloadLink = "<a id='SaveLink' href='data:application/xml;charset=utf-8," + FTLtext +"' download='content.ftl'></a>";
	//$("#saveFTL").wrap(downloadLink);
}

$("#sendbutton").click(SendSQL);

//Sends query to serverside and the database
function SendSQL(){
	var SqlQuery = {};
	SqlQuery["query"] = $("#SQL").text();	
	$.post('http://localhost:1337/sovy_testo', SqlQuery, function (error) 
	{
			if(error.code == "42P07") 
			{
				if (confirm("Sökvyn med namnet finns redan, vill du ta bort och skapa ny?")) {
					SqlQuery["query"] = "DROP VIEW " + $("#sokvy").text() + "; " + SqlQuery["query"];
					$.post('http://localhost:1337/sovy_testo', SqlQuery, function(err)
					{
						if(err.code != undefined) alert("Något gick fel");
						else alert("Sökvy skapad");
					});
				}
			}
            else
			{
				alert("Sökvy skapad");
			}
    });
}

/*Toggles between text input field and paragraph
	and makes it possible to change what is in
	the paragraph*/
function changeText(button,idText,idInput){

	if(!IlligalChar($("#"+idInput).val()) && $(button).text()== "Bekräfta"){ 
		alert("Endast engelska bokstäver, siffror och understreck. Måste börja med en bokstav.");
		return;
	}

	$("#"+idInput).toggle();
	$("#"+idText).toggle();
	$("#"+idText).text($("#"+idInput).val());
	if($(button).text() == "Ändra") { $(button).text("Bekräfta"); }
	else 
	{
		$("#sendbutton").prop('disabled', 'true');
		$(button).text("Ändra");
	}
}

$("#fler_kolumner").on('change', function(){
	$("#sendbutton").prop('disabled', 'true');
	});

function IlligalChar(strToCheck){
var Regexp = /^[a-z][a-z0-9_]*$/i;//Only allows for English chars, numbers and underscore (͡°͜ʖ͡°)
return Regexp.test(strToCheck);
}

function SQLBuilder (data) {

    var tabelln = data.tabellnamn;
    var sokvyn = data.sokvynamn;
    var where = data.where;
    var titel = data.titel;
    var sokbara = "";
    var sistaknamn = "";
    var skapasokvy_str = "CREATE VIEW ";
	var finnsSokBar = false;
	var finnsWhere = (where=='') ? ';':'';
    skapasokvy_str += sokvyn; 
    skapasokvy_str += " AS SELECT ";
    skapasokvy_str += '"' + tabelln + '".geom, ' + '"' + tabelln + '".geodb_oid AS sokid, ';

    function process(key, value) {
        console.log("Nyckel: " + key + " : " + "värde: " + value); //stoppa i sträng
        if (key == "kolumn") 
		{
            skapasokvy_str += '"' + tabelln + '"."' + value + '"';
            sistaknamn = value;
        }
        else if (key == "title") 
		{
            if (value == "j") 
			{
				skapasokvy_str += " AS title, ";
			}
            else 
			{
                skapasokvy_str += ", "; 
            }
        }


        else if(key == "sokdel") 
        {
            if (value == "j") 
			{
                sokbara += '"' + sistaknamn +'",';
				finnsSokBar = true;
            }
        }
          
    };
    function traverse(o, func) {
        for (let i in o) {
            if (o[i] !== null && typeof (o[i]) == "object") {
                traverse(o[i], func);
            }
            else if (i == "kolumn" || i == "title" || i == "sokdel") {
                func.apply(this, [i, o[i]]); //http://www.w3schools.com/js/js_function_invocation.asp
            }
        }
    };
    traverse(data, process);
    sokbaraArray = sokbara.split(",");
    sokbaraArray.pop();	

	
	if(finnsSokBar)	
	{
		skapasokvy_str += " concat_ws(', '," + sokbaraArray + ")::text AS searchfield ";
	} 
	else
	{
		//replace "," with space for correct sql syntax
		skapasokvy_str = skapasokvy_str.substring(0,skapasokvy_str.length-2); 
		skapasokvy_str += " ";
	}	

	skapasokvy_str += "FROM " + '"' + tabelln +'" '+where + finnsWhere;
    console.log(skapasokvy_str);
    return skapasokvy_str;
}

/*$("#addFTLLink").click(AddLink)

function AddLink(){
	$("#FTLLink").toggle();
	$("#FTLLinkNamn").toggle();
	$("#FTLLinkp").toggle();
	$("#FTLLinkNamnp").toggle();
	$(".plink").css('display', 'block');
	if($("#addFTLLink").text() == "Lägg till länk" || 
		$("#addFTLLink").text() == "Ändra länk")
	{
		$("#addFTLLink").text("Bekräfta");
	}
	else{	
		$("#addFTLLink").text("Ändra länk");
		$("#FTLLinkp").text($("#FTLLink").val());
		$("#FTLLinkNamnp").text($("#FTLLinkNamn").val());
	}
}*/

$("#tabellInfo").on('click', function (){
	alert("- Till vänster listas sökvyer som specifierats i layerspecification-tabellen i databasen.\n"+
	"- Informationen under kommer också direkt från layerspecifications.\n"+
	"- Vid ändring av sökvynamn, tänk på att sökvyn kanske inte finns specifierad i layerspecification-tabellen.\n"+
	"- Tabell: Vilken tabell som används för sökvyn.\n- Sökvy: Vad sökvyn du skapar heter.\n- Titel: Sökvyns titel i geoserver. \n- Where: Sökvyns where-sats.");
});
	
$("#kolumnInfo").on('click', function (){
	alert("- Lägg till de kolumner du vill ha i din sökvy.\n- Välj vilken som ska vara 'title'.\n- Sökbara kolumner läggs till i searchfield i sökvyn.\n"+
	"- För att kolumnen ska vara med i FTL-filen så skriver du något i FTL-fältet.");
});

$("#SQLInfo").on('click', function (){
	alert("- Här visas SQL-koden.\n- Tänk på att det krävs en 'title' för att visa koden.\n"+
	"- När du är nöjd kan du trycka på 'Skapa sökvyn' för att skapa den i databasen.");
});

$("#FTLInfo").on('click', function (){
	alert("- Här visas FTL-koden.\n- Du kan lägga till en länk så genereras den i FTL-koden.\n"+
	"- Spara-knappen laddar ner en 'config.ftl'.\n- Om du inte får välja vart den sparar så hamnar den nog på standardplatsen för hämtade filer."+
	"\n- Om du vill ha fler länkar eller inte nöjd med"+
	" vart länken befinner sig så kan du kopiera raden, flytta den eller ange ny URL och namn.");
});

$("#modifyFTL").click(ModFTL);

$("#calcFTL").click(CheckFTLButtons);

function CheckFTLButtons(){
	$('#saveFTL').prop("disabled", false);
	$("#calcFTL").text("Återställ FTL");
	$("#modifyFTL").css('display', 'inline-block');
}

function ModFTL(){
	if($("#modifyFTL").text() == "Modifiera"){
		$("#textareaFTL").prop('disabled',false);
		$("#modifyFTL").toggle();
	}
}

$("#FTLcodesButton").click(function(){
	$("#FTLCodeSnippets").css("display",'block');
	$(this).toggle();
});

$("#closeFTLCode").click(function(){
	$("#FTLCodeSnippets").css("display",'none');
	$("#FTLcodesButton").toggle();
});
	
//jqueryUI för att göra lista DOMelement sorterbar
$('#fler_kolumner tbody').sortable();
</script>
</body>
</html>





















