<!DOCTYPE html>
<html lang="en">
<head>
    <title>Jej er en fin haj</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
	<style>
		.margin-left{
		margin-left: 0.5em;
		}
	</style>
</head>
<body>
    <div class="container-fluid" style="background-color:#33928C;">
        <div class="col-sm-6">
            <div class="row" style="background-color:#33928C;">
                <select id="layerspecs" label="Select one:"></select> <br> < (Innehållet i tabellen nedan ersätts när ny spec väljs och dess postgrestabell hämtas)
                <h3>Tabell</h3>
                <p id="tabell">mellow</p>
                <h3>Sökvy</h3>
                <p id="sokvy"></p>
                <h3>Titel</h3>
                <p id="titel"></p>
                <h3>Where</h3>
                <p id="where"></p>
            </div>
			<div class="row" style="background-color:#F28986;">
                <h3>Inkluderade kolumner med ev. alias</h3>
                <h4 id=titelkomihag>( Ange "title" som alias för en kolumn )</h4>
                <table class="table table" id="fler_kolumner">
                    <!--Ändras kanske senare till att läsa från tabell i db "eskilstuna".-->

					<tbody id=mainbody>
						<tr>
							<th>Försvinn!</th>
							<th>Kolumnnamn</th>
							<th>Title</th>
							<th>Sökbar kolumn</th>
						</tr>
						<tr>
							<td>
								<button type="button" class="btn btn-danger" name="bortknapp">X</button>
							</td>
							<td>
								<!--<input type="text" id="kolumn" name="kolumn">-->
								<select class="dropbox" id="kolumn" name="kolumn">
								</select>
							</td>
							<td>
								<input onchange='checkbox(this)' type='checkbox' id='title' class='title_check'>
								<!-- Varför heter alias titel? En kolumn ska läggas till sökvyn som heter 'title' och har värdet av en tabellkolumn, men hur blir tillagd rad ny radioknapp i existerande grupp? Check efter "title" istället för ny ful knappkolumn, skriv / poppa upp varning och
								-->
							</td>
							<td>
								<input type="checkbox" id="sokdel" name="checkbox">
							</td>
						</tr>
					</body>
				
                </table>
				<button type="button" class="add-all-columns btn btn-info" style="position: relative; float: right; bottom: 1em; right: 0.5em;">Lägg till<br> alla kolumner</button>
                <button class="btn btn-info" id="addbutton" style="position: relative; left: 0.5em;">+1</button>
            </div>
        </div>
        <div class="col-sm-6">
		
            <div class="row" style="background-color:#97B6CB;" >
                <h3 class="margin-left">SQL</h3>
                <div class="margin-left" readonly id="sql" rows="5" cols="70" autocomplete="off"></div>
                <button type="button" class="btn btn-info margin-left" id="calcbutton">Show SQL</button>
                <button type="button" class="btn btn-info margin-left" id="sendbutton">Send</button>
            </div>
			
			<div class="row" style="background-color:green;">
                <h3 class="margin-left">FTL</h3>
                <div class="margin-left" readonly id="ftl" rows="5" cols="70" autocomplete="off"></div>
                <button type="button" class="btn btn-info margin-left" id="calcFTL">Show FTL</button>
            </div>
            
        

		</div>

<script type="application/javascript">
    //When DOM ready then call node js server and receive layer_spec from db:geoportia then populate selector
    $(function () {

        let lagerspecar = "kattkatt";

        $.ajax({
            type: 'GET',
            url: 'http://localhost:1337/geoportia',

            success: function (json) {
                lagerspecar = json;
                lagerspecar.forEach(function (v) {
                    var opt = document.createElement('option');
                    opt.textContent = v.name;
                    opt.value = v.name + "|" + v.public_title + "|" + v.postgis_table_name + "|" + v.postgis_view_where_condition;
                    $("#layerspecs").append(opt);
                });
                // $("#layerspecs").append('<option value='+ object.public_title + '>' + object.name + '</option>');
            }

        });


    });
  
    //Function som skriver ut object
    function printObject(o) {
      var out = '';
        for (var p in o) {
            out += p + ': ' + o[p] + '\n';
        }
        console.log(out);
    }



//fill dropbox with table column names from the database
function fillDropBox(kolumner){
	$(".dropbox_option").remove();
	kolumner.forEach(function (kolumn) {
		let option = document.createElement('option');
		option.className = "dropbox_option";
		option.textContent = kolumn.column_name;
		$(".dropbox").append(option);
		});
};		
			
	
//onchange='checkbox()'
//creates a string which you can insert in the html to create a  new row
function createRow(){
	let row = "<tr>";
	let removeButton = "<td><button type='button' class='btn btn-danger' name='bortknapp'>X</button></td>";
	let columnName = "<td><select class='dropbox' id='kolumn' name='kolumn'></select></td>";
	let titleBox = "<td><input onchange='checkbox(this)' type='checkbox' id='title' class='title_check'></td>";
	let searchBox = "<td><input type='checkbox' id='sokdel' name='checkbox'></td>";
	row += removeButton + columnName + titleBox + searchBox + "</tr>";
	return row;
};

//onclick event in the html
//unchecks all title-checkboxes except for the one you click.
function checkbox(title){
	$('input[id="' + title.id + '"]').not(title).prop('checked', false);
}
	

	

function update_fixed_fields(array) {
    console.log("I uppdatera_fixed_fields");
    //document.getElementById("tabell").innerHTML=array[2];
    $('#sokvy').text(array[0]);
    $('#titel').text(array[1]);
    $('#tabell').text(array[2]);
    if (array[3] != 'null') {
        $('#where').text(array[3]);
    } else { $('#where').text("") };
};

//reads the current table from the database to get the columns
function readTableColumns(){
	let layerspecs = document.getElementById("layerspecs");
	let split = layerspecs.value.split("|");
	update_fixed_fields(split);
	$.ajax({
        type: 'GET',
        url: 'http://localhost:1337/eskilstuna/' + $('#tabell').text(),
        success: function (json) {
            fillDropBox(json);	//use the columns to fill/update the dropbox
			updateAllDropboxes();
        }
	})
}

//remove all rows except the first one and update the data
$("#layerspecs").on('change', function(){
	let length = $(".dropbox").length - 1;
	$("#fler_kolumner tr:gt(1)").remove();
	readTableColumns();
	});

//Function som skriver ut object
function printObject(o) {
		var out = '';
		for (var p in o) {
			out += p + ': ' + o[p] + '\n';
		}
	console.log(out);
}


//reads columns from database and updates the whole table
$(".add-all-columns").on('click', function(){
	let layerspecs = document.getElementById("layerspecs");
	//console.log(layerspecs.value);
	let split = layerspecs.value.split("|");
	update_fixed_fields(split)
	$.ajax({
        type: 'GET',
        url: 'http://localhost:1337/eskilstuna/' + $('#tabell').text(),
        success: function (json) {
            setTable(json);
		}
    });
});

//sets dropboxes default value based on thier index, ex row 2 by default will have value from column 2
function updateAllDropboxes(){
	$('.dropbox').each(function (index){
		let box = $(this);
		let options = box.children();
		if(options.length > index){
			box.val(options[index].text); 
		}
	}); 

}

/*copies data from above row and
	sets dropbox default value to whatever
	its index is, same as updateAllDropboxes
	but for +1 clickevent*/
function updateNewDropbox(){
	let index = $(".dropbox").length - 1;
	let newDropBox = $("table").find("select:last");
	$("#kolumn:first option").each(function(){
		let opt = document.createElement('option');
		opt.textContent = this.text;
		opt.className = "dropbox_option";
		newDropBox.append(opt);
	})
	let options = newDropBox.children();
	if(options.length > index){
		newDropBox.val(options[index].text);
	}
}
	

/*adds a new row when clicking on +1*/
$("#addbutton").click(function () {
	$("table").append(createRow()); // new createRow func
	updateNewDropbox();	//update the new dropbox
	
});


/*creates all needed rows and then calls readTableColumns
	to set the value on the dropboxes*/
function setTable(huvuden) { //Set table
    $("#fler_kolumner tr").each(function () {
       $("#fler_kolumner").find("tr:gt(" + ((huvuden.length > 0) ? 0 : 1) + ")").remove(); //välj alla element med högre index än 1, dvs 2->
        console.log($(this).val());
    });
    $.each(huvuden, function (index, object){
        $("#fler_kolumner tr:last").after(createRow());
    });
	readTableColumns();
	
};


//clickevent to remove a row
$(document).on('click', 'button.btn-danger', function () {
    var rows = $("#mainbody").children(); 
	if(rows.length > 2)
		$(this).closest('tr').remove();
});

$("#calcbutton").click(function () {   //Utvinn tabellens värden, kontrollera, post om så, return om ej

    var samling = {}; //tabellobjekt
    var title_is_present = false;

    function illegalCharsCheck(string) { //Returnerar falskt om inkommande sträng ej innehåller känt problematiskt tecken
        if (!(string.indexOf(" ") > -1) && !(string.indexOf("/") > -1) && !(string.indexOf("Å") > -1) && !(string.indexOf("å") > -1) && (!string.indexOf("Ä") > -1) && !(string.indexOf("ä") > -1) && !(string.indexOf("Ö") > -1) && !(string.indexOf("ö") > -1)) {
            return false
        }
        else {
            return true
        }
        }

        $('#fler_kolumner tr').each(function (k) {// 'table row'


            var obj = {}; //js-objekt som representerar en rad

            $(this).find("input,select").each(function (i) {
                //console.log($(this).);
                if (this.id.indexOf('sokdel') >= 0) {
                    if ($(this).is(":checked")) {
                        obj["sokdel"] = "j";
                    }
                    else {
                        obj["sokdel"] = "n";
                    }
                }
				else if (this.id.indexOf('title') >= 0) {
					if($(this).is(":checked")){
						title_is_present = true;
						obj["title"] = "j";
					}
					else{
						obj["title"] = "n";
					}
				}
				else {
                    obj["kolumn"] = $(this).val();
				}
			});
        samling["row" + k] = obj;
		console.log(["row"+k] + " Kolumn: "+ obj["kolumn"]);

    });
    //console.log("här är hopsamling av tabellen, tja.html"+ JSON.stringify(samling)); //Vi bör kunna göra en rätt snyggo json här va, som sen kan skickas
    if (!title_is_present) {
		alert("Måste ange en title");
        //$("#titelkomihag").fadeOut(700).fadeIn(700).fadeOut(700).fadeIn(700);
        return;
    }
    else {

        samling["tabellnamn"] = $('#tabell').text();
        samling["sokvynamn"] = $('#sokvy').text();
        samling["titel"] = $('#titel').text();
        samling["where"] = $('#where').text();

        $.post('http://localhost:1337/eskilstuna_nyvy', samling, function (data, status) {

            $('#sql').html("<code>" + data + "</code>"); //klienten behöver formatera svaret för visning i div, nyrad vid första AS, FROM, WHERE
            console.log("Data: " + data + "\nStatus: " + status);
            });
        }
});
	
$("#calcFTL").click(function(){ 
let OT = "&lt;";
let CT = "&gt;";
let BR = "<br>";
let OUL = OT+"ul"+CT+BR;
let CUL = OT+"/ul"+CT+BR;
let FTLbegin = OT+"#list features as feature"+CT+BR+OT+'table class="featureInfo"'+CT+BR+OUL;

let FTLmiddle = "";

let FTLend = CUL+OT+"/table"+CT+BR+OT+"/#list"+CT;
let dummy = ["one","","three","","five"];

for(amount in dummy)
{
	if(dummy[amount] != "")
	FTLmiddle += OT+"tr"+CT+BR+OT+"td"+CT+dummy[amount]+" ${feature."+dummy[amount]+".value}"+OT+"/td"+CT+BR+OT+"/tr"+CT+BR
}

$('#ftl').html("<code>"+FTLbegin+FTLmiddle+FTLend+"</code>"); 
});


//jqueryUI för att göra lista DOMelement sorterbar
$('#fler_kolumner tbody').sortable();

</script>
</html>
